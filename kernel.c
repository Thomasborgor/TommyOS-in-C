// kernel.c
#include <stdint.h>
// font8x8_uppercase.h
static const unsigned char font8x8[128][8] = {
    // 0–31: control characters, all zeros
    {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0},
    {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0}, {0,0,0,0,0,0,0,0},

    // 32: space ' '
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // 33: !
    {0x18,0x3C,0x3C,0x18,0x18,0x00,0x18,0x00},
    // 34: "
    {0x36,0x36,0x24,0x00,0x00,0x00,0x00,0x00},
    // 35: #
    {0x36,0x36,0x7F,0x36,0x7F,0x36,0x36,0x00},
    // 36: $
    {0x0C,0x3E,0x03,0x1E,0x30,0x1F,0x0C,0x00},
    // 37: %
    {0x00,0x63,0x33,0x18,0x0C,0x66,0x63,0x00},
    // 38: &
    {0x1C,0x36,0x1C,0x6E,0x3B,0x33,0x6E,0x00},
    // 39: '
    {0x0C,0x0C,0x18,0x00,0x00,0x00,0x00,0x00},
    // 40: (
    {0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x00},
    // 41: )
    {0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0x00},
    // 42: *
    {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00},
    // 43: +
    {0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00},
    // 44: ,
    {0x00,0x00,0x00,0x00,0x18,0x18,0x30,0x00},
    // 45: -
    {0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00},
    // 46: .
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00},
    // 47: /
    {0x03,0x06,0x0C,0x18,0x30,0x60,0xC0,0x00},
    
    // 48–57: 0–9
    {0x3C,0x66,0x6E,0x7E,0x76,0x66,0x3C,0x00}, // 0
    {0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00}, // 1
    {0x3C,0x66,0x06,0x0C,0x30,0x60,0x7E,0x00}, // 2
    {0x3C,0x66,0x06,0x1C,0x06,0x66,0x3C,0x00}, // 3
    {0x0C,0x1C,0x3C,0x6C,0x7E,0x0C,0x0C,0x00}, // 4
    {0x7E,0x60,0x7C,0x06,0x06,0x66,0x3C,0x00}, // 5
    {0x3C,0x60,0x7C,0x66,0x66,0x66,0x3C,0x00}, // 6
    {0x7E,0x66,0x0C,0x18,0x18,0x18,0x18,0x00}, // 7
    {0x3C,0x66,0x66,0x3C,0x66,0x66,0x3C,0x00}, // 8
    {0x3C,0x66,0x66,0x3E,0x06,0x06,0x3C,0x00}, // 9

    // 58–64: punctuation
    {0x00,0x18,0x18,0x00,0x18,0x18,0x00,0x00}, // :
    {0x00,0x18,0x18,0x00,0x18,0x18,0x30,0x00}, // ;
    {0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x00}, // <
    {0x00,0x00,0x7E,0x00,0x7E,0x00,0x00,0x00}, // =
    {0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x00}, // >
    {0x3C,0x66,0x06,0x0C,0x18,0x00,0x18,0x00}, // ?
    {0x3C,0x66,0x6E,0x6A,0x6E,0x60,0x3C,0x00}, // @

    // 65–90: A–Z
    {0x18,0x3C,0x66,0x66,0x7E,0x66,0x66,0x00}, // A
    {0x7C,0x66,0x66,0x7C,0x66,0x66,0x7C,0x00}, // B
    {0x3C,0x66,0x60,0x60,0x60,0x66,0x3C,0x00}, // C
    {0x78,0x6C,0x66,0x66,0x66,0x6C,0x78,0x00}, // D
    {0x7E,0x60,0x60,0x7C,0x60,0x60,0x7E,0x00}, // E
    {0x7E,0x60,0x60,0x7C,0x60,0x60,0x60,0x00}, // F
    {0x3C,0x66,0x60,0x6E,0x66,0x66,0x3C,0x00}, // G
    {0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x00}, // H
    {0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00}, // I
    {0x1E,0x0C,0x0C,0x0C,0x0C,0x6C,0x38,0x00}, // J
    {0x66,0x6C,0x78,0x70,0x78,0x6C,0x66,0x00}, // K
    {0x60,0x60,0x60,0x60,0x60,0x60,0x7E,0x00}, // L
    {0x63,0x77,0x7F,0x6B,0x63,0x63,0x63,0x00}, // M
    {0x66,0x76,0x7E,0x7E,0x6E,0x66,0x66,0x00}, // N
    {0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00}, // O
    {0x7C,0x66,0x66,0x7C,0x60,0x60,0x60,0x00}, // P
    {0x3C,0x66,0x66,0x66,0x6E,0x6C,0x36,0x00}, // Q
    {0x7C,0x66,0x66,0x7C,0x78,0x6C,0x66,0x00}, // R
    {0x3C,0x66,0x30,0x1C,0x06,0x66,0x3C,0x00}, // S
    {0x7E,0x5A,0x18,0x18,0x18,0x18,0x3C,0x00}, // T
    {0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00}, // U
    {0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00}, // V
    {0x63,0x63,0x63,0x6B,0x7F,0x77,0x63,0x00}, // W
    {0x66,0x66,0x3C,0x18,0x3C,0x66,0x66,0x00}, // X
    {0x66,0x66,0x66,0x3C,0x18,0x18,0x3C,0x00}, // Y
    {0x7E,0x06,0x0C,0x18,0x30,0x60,0x7E,0x00}, // Z

    // 91–96: [ \ ] ^ _
    {0x3C,0x30,0x30,0x30,0x30,0x30,0x3C,0x00}, // [
    {0xC0,0x60,0x30,0x18,0x0C,0x06,0x03,0x00}, // '\'
    {0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00}, // ]
    {0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00}, // ^
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF}, // _
	{0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},

    // 97–122: a–z
    {0x00,0x00,0x3C,0x06,0x3E,0x66,0x3E,0x00}, // a
    {0x60,0x60,0x7C,0x66,0x66,0x66,0x7C,0x00}, // b
    {0x00,0x00,0x3C,0x66,0x60,0x66,0x3C,0x00}, // c
    {0x06,0x06,0x3E,0x66,0x66,0x66,0x3E,0x00}, // d
    {0x00,0x00,0x3C,0x66,0x7E,0x60,0x3C,0x00}, // e
    {0x0C,0x18,0x3E,0x18,0x18,0x18,0x18,0x00}, // f
    {0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x3C}, // g
    {0x60,0x60,0x7C,0x66,0x66,0x66,0x66,0x00}, // h
    {0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00}, // i
    {0x0C,0x00,0x1C,0x0C,0x0C,0x0C,0x6C,0x38}, // j
    {0x60,0x60,0x66,0x6C,0x78,0x6C,0x66,0x00}, // k
    {0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00}, // l
    {0x00,0x00,0x6E,0x7F,0x6B,0x63,0x63,0x00}, // m
    {0x00,0x00,0x7C,0x66,0x66,0x66,0x66,0x00}, // n
    {0x00,0x00,0x3C,0x66,0x66,0x66,0x3C,0x00}, // o
    {0x00,0x00,0x7C,0x66,0x66,0x7C,0x60,0x60}, // p
    {0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x06}, // q
    {0x00,0x00,0x6C,0x76,0x60,0x60,0x60,0x00}, // r
    {0x00,0x00,0x3E,0x60,0x3C,0x06,0x7C,0x00}, // s
    {0x18,0x18,0x3E,0x18,0x18,0x18,0x0C,0x00}, // t
    {0x00,0x00,0x66,0x66,0x66,0x66,0x3E,0x00}, // u
    {0x00,0x00,0x66,0x66,0x66,0x3C,0x18,0x00}, // v
    {0x00,0x00,0x63,0x63,0x6B,0x7F,0x36,0x00}, // w
    {0x00,0x00,0x66,0x3C,0x18,0x3C,0x66,0x00}, // x
    {0x00,0x00,0x66,0x66,0x66,0x3E,0x06,0x3C}, // y
    {0x00,0x00,0x7E,0x0C,0x18,0x30,0x7E,0x00}, // z

    // 123–126: { | } ~
    {0x0E,0x18,0x18,0x70,0x18,0x18,0x0E,0x00}, // {
    {0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x00}, // |
    {0x70,0x18,0x18,0x0E,0x18,0x18,0x70,0x00}, // }
    {0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00}, // ~

    // 127: DEL, empty
    {0,0,0,0,0,0,0,0}
};

#define MULTIBOOT2_MAGIC 0x36d76289
#define FRAMEBUFFER_TAG  8

typedef struct {
    uint32_t tag_type;
    uint32_t tag_size;
    uint64_t framebuffer_addr;
    uint32_t framebuffer_pitch;
    uint32_t framebuffer_width;
    uint32_t framebuffer_height;
    uint8_t framebuffer_bpp;
    uint8_t framebuffer_type;
    uint16_t reserved;
} framebuffer_tag_t;
framebuffer_tag_t* fb = 0;

void putPixel(framebuffer_tag_t* fb, int x, int y, uint32_t color) {
    uint32_t* pixel = (uint32_t*)(fb->framebuffer_addr + y * fb->framebuffer_pitch + x * (fb->framebuffer_bpp / 8));
    *pixel = color;
}

void rect(int x_start, int y_start, int width, int height, uint32_t color) {
	for (int y = 0; y < y_start + height; y++) {
        for (int x = 0; x < x_start + width; x++) {
            putPixel(fb, x, y, color); // White in 32-bit ARGB
        }
    }
}

void init(uint32_t magic, uint32_t addr) {
	if (magic != MULTIBOOT2_MAGIC) {
		
        while (1); // Not loaded by Multiboot2
    }

    uint8_t* tag_ptr = (uint8_t*)addr + 8; // Skip total_size + reserved
    

    while (*(uint32_t*)tag_ptr != 0) {
        uint32_t type = *(uint32_t*)tag_ptr;
        uint32_t size = *(uint32_t*)(tag_ptr + 4);

        if (type == FRAMEBUFFER_TAG) {
            fb = (framebuffer_tag_t*)tag_ptr;
            break;
        }

        // Move to next tag (8-byte aligned)
        tag_ptr += ((size + 7) & ~7);
    }

    if (!fb) {
        while (1); // No framebuffer found
    }
}


void putPixel2x2(framebuffer_tag_t* fb, int x, int y, uint32_t color) {
    // Draw a 2x2 block for bigger text
    for (int dy = 0; dy < 2; dy++) {
        for (int dx = 0; dx < 2; dx++) {
            putPixel(fb, x + dx, y + dy, color);
        }
    }
}

void printChar(int x_start, int y_start, char ch, uint32_t color) {
    uint8_t* bitmap = font8x8[(uint8_t)ch];

    for (int row = 0; row < 8; row++) {
        uint8_t rowData = bitmap[row];
        for (int col = 0; col < 8; col++) {
            if (rowData & (1 << (7 - col))) {
                putPixel2x2(fb, x_start + col*2, y_start + row*2, color);
            }
        }
    }
}

void print(int x, int y, char *string, uint32_t color) {
    for (int i = 0; string[i] != '\0'; i++) {
        printChar(x, y, string[i], color);
        x += 16; // 8 pixels * 2 for scaling
    }
}


void kernelMain(uint32_t magic, uint32_t addr) {
    init(magic, addr);
	
	rect(0,0,800,600,0x00000000);
	print(0,0,"Welcome to TommyOS!", 0x7F7F7F7F);
	print(0,16,"Now in C!", 0x7F7F7F7F);

    while (1); // Halt
}



